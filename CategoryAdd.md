# 0. 目的と前提

* **目的**: 「教育」「可視化」に偏る傾向を抑え、**VR/CG/インタラクション系**の候補を適切に上位へ押し上げる。
* **前提**: ベースは **bge-m3 によるテキスト↔カテゴリ埋め込み類似度（cosine）**。
  その上に **ルールベースのキーワード加点＋抑制** を薄く重ねる“ハイブリッド採点”。

---

# 1. 入出力仕様

**入力:**

* `text` : 任意の日本語テキスト

**出力:**

* `top3`: `[{"label": str, "score": float, "source": "hybrid"}, ...]`
* `need_review`: `"yes" | "no"`

**中間:**

* `base_scores`: `{label: float}`（bge-m3コサイン類似度）
* `rule_bonus`: `{label: float}`（キーワード命中による加点\[0..BONUS\_CAP]）
* `final_scores`: `{label: float}`（合成後スコア\[0..1]）

---

# 2. 正規化・形態処理

* **Unicode正規化**: NFKC
* **英数小文字化**
* **空白/制御/記号の正規化**: 連続空白→1、全角・半角統一
* **カタカナ表記統一**（例: ｲﾝﾀﾗｸｼｮﾝ→インタラクション）
* 任意: **形態素解析**で名詞・外来語抽出（Sudachi「C」モード推奨）

`normalize(text)` はこの処理を施す。

---

# 3. カテゴリ辞書（詳細版・叩き台）

**設計方針**

* `strong`: 命中時に**強い示唆**（固有名詞・装置名・技術キーワード）
* `weak`: 補助的示唆（一般語・周辺語）
* 英語/表記ゆれ/略称/同義語を極力カバー
* **否定語**（anti）を用意：命中時に**抑制**（例: “教育指導要領”は「教育」を強める等、逆に「純VR研究」文脈を弱めるものをantiに入れる）—今回は代表のみ記載

```json
{
  "CG・デジタルアーカイブ": {
    "strong": ["デジタルアーカイブ", "文化財", "文化遺産", "博物館資料", "フォトグラメトリ", "写真測量", "三次元復元", "3D復元", "点群", "LiDAR", "レーザースキャン", "スキャンデータ", "メッシュ再構成", "SfM", "Structure from Motion"],
    "weak": ["モデリング", "リトポロジー", "リトポ", "UV展開", "テクスチャ", "ベイク", "レンダリング", "GLTF", "GLB", "OBJ", "PLY", "点群処理", "データ保存", "アノテーション"],
    "anti": []
  },
  "VR空間": {
    "strong": ["VR空間", "仮想空間", "仮想環境", "仮想世界", "メタバース", "VRChat", "cluster", "Neos", "Spatial", "HMD", "ヘッドマウントディスプレイ", "Oculus", "Meta Quest", "Quest2", "Quest3", "Vive", "Index", "OpenXR"],
    "weak": ["インスタンス", "ワールド", "ルームスケール", "トラッキング", "フルトラ", "IK", "アイトラ", "ハンドトラッキング", "アイトラッキング"],
    "anti": []
  },
  "アバター": {
    "strong": ["アバター", "アバター生成", "アバター編集", "フェイシャル", "表情認識", "モーションキャプチャ", "モーキャプ", "リギング", "スキニング", "ボーン", "ブレンドシェイプ", "VRCアバター", "VRM", "Humanoid"],
    "weak": ["衣装", "衣装替え", "髪物理", "揺れもの", "体型調整", "顔トラッキング", "表情制御"],
    "anti": []
  },
  "インタラクション": {
    "strong": ["インタラクション", "UI", "UX", "操作手法", "選択操作", "ポインティング", "ジェスチャ", "姿勢推定", "身体性", "ハプティクス", "触覚提示", "力覚提示", "モーダル切替", "メニュー操作"],
    "weak": ["没入感", "プレゼンス", "使い勝手", "フィードバック", "提示手法", "視線入力", "手入力", "音声入力"],
    "anti": []
  },
  "エージェント": {
    "strong": ["エージェント", "会話エージェント", "対話エージェント", "自律エージェント", "LLMエージェント", "NPC", "行動計画", "プランニング", "強化学習", "RL", "Reinforcement Learning"],
    "weak": ["アシスタント", "ナビゲーション", "案内", "対話支援", "ルールベース"],
    "anti": []
  },
  "コミュニケーション": {
    "strong": ["コミュニケーション", "会話", "対話", "交流", "ソーシャルサポート", "関係構築", "協調作業", "コラボレーション"],
    "weak": ["雑談", "アイスブレイク", "発話", "感情", "感情推定", "同席感"],
    "anti": []
  },
  "ソーシャルVR": {
    "strong": ["ソーシャルVR", "VRChat", "cluster", "Neos", "メタバースプラットフォーム", "インスタンス制御", "フレンド機能", "イベント開催"],
    "weak": ["アバターマーケット", "ワールドアップロード", "コミュニティ運営", "Booth", "配信イベント"],
    "anti": []
  },
  "可視化": {
    "strong": ["可視化", "視覚化", "可視化手法", "可視化技術", "可視化結果", "ボリュームレンダリング", "等値面", "流線", "点群可視化"],
    "weak": ["3D可視化", "VR可視化", "インタラクティブ可視化", "可視化ツール"],
    "anti": []
  },
  "工学・サイエンスコミュニケーション": {
    "strong": ["科学コミュニケーション", "サイエンスコミュニケーション", "アウトリーチ", "展示解説", "科学館", "博物館", "ミュージアム", "STEAM"],
    "weak": ["市民参加", "ワークショップ", "普及啓発", "体験学習"],
    "anti": []
  },
  "応用数理": {
    "strong": ["最適化", "数値解析", "数理モデル", "シミュレーション", "微分方程式", "ベイズ推定", "確率過程", "離散化", "有限要素法", "FEM"],
    "weak": ["近似", "数理的", "解析的", "再現実験"],
    "anti": []
  },
  "感覚・知覚": {
    "strong": ["知覚", "感覚", "多感覚", "触覚", "前庭", "視覚認知", "錯視", "VR酔い", "サッカード", "順応", "感度"],
    "weak": ["感性", "疲労", "快不快", "主観評価", "SSQ", "SUS"],
    "anti": []
  },
  "教育": {
    "strong": ["教育", "授業", "教材", "学習", "訓練", "トレーニング", "指導", "評価", "ルーブリック", "授業設計"],
    "weak": ["eラーニング", "学習効果", "学習支援", "教育実践", "実証授業"],
    "anti": []
  },
  "機械学習": {
    "strong": ["機械学習", "ディープラーニング", "深層学習", "ニューラルネットワーク", "Transformer", "BERT", "学習モデル", "分類器", "回帰"],
    "weak": ["特徴量", "埋め込み", "ベクトル", "クラスタリング", "次元削減"],
    "anti": []
  },
  "社会": {
    "strong": ["社会", "倫理", "ガバナンス", "プライバシー", "規範", "制度", "アクセシビリティ", "包摂", "障害当事者"],
    "weak": ["普及", "受容", "合意形成", "文化", "コミュニティ規約"],
    "anti": []
  }
}
```

> 運用中に**固有名詞**（新機種・新機能・新プラットフォーム）を随時 `strong` に足していくのがコツ。

---

# 4. 採点ロジック（ハイブリッド）

## 4.1 加点関数

* `s_hits = 強語命中数（上限 S_CAP）`
* `w_hits = 弱語命中数（上限 W_CAP）`
* `bonus = S_WEIGHT * s_hits + W_WEIGHT * w_hits` を **BONUS\_CAP** でクリップ

**推奨初期値**

* `S_WEIGHT = 1.0`
* `W_WEIGHT = 0.25`
* `S_CAP = 3`
* `W_CAP = 5`
* `BONUS_CAP = 4.0`

## 4.2 合成

* `final = ALPHA * base + BETA * (bonus / BONUS_CAP)`
* **推奨初期値**: `ALPHA = 0.80`, `BETA = 0.20`

## 4.3 強制候補化（下駄）

* もし `s_hits >= 1` なら、そのカテゴリの最終スコアを少なくとも `FLOOR_FORCED` に引き上げる。
* **推奨初期値**: `FLOOR_FORCED = 0.60`

## 4.4 過吸引の抑制

* 文章内に **VR系強語**（`VR空間`/`インタラクション`/`アバター` の strong）が1つ以上あれば、
  `教育` と `可視化` の最終スコアに **−DAMP**（クリップ下限0.0）
* **推奨初期値**: `DAMP = 0.03`（やりすぎ注意）

## 4.5 need\_review 判定

* `top1 - top2 < TIE_DELTA` なら `"yes"`
* **推奨初期値**: `TIE_DELTA = 0.03`

---

# 5. 擬似コード

```pseudo
function classify(text, category_vectors):
    t = normalize(text)

    # 1) bge-m3 base scores
    text_vec = embed_bge_m3(t)
    base_scores = {cat: cosine(text_vec, category_vectors[cat]) for cat in CATEGORIES}

    # 2) rule bonuses + hybrid combine
    final_scores = {}
    forced_flags = set()

    for cat in CATEGORIES:
        (s_hits, w_hits) = count_hits(t, SEED[cat])
        bonus = min(S_WEIGHT * min(s_hits, S_CAP) + W_WEIGHT * min(w_hits, W_CAP), BONUS_CAP)
        base  = base_scores.get(cat, 0.0)
        final = ALPHA * base + BETA * (bonus / BONUS_CAP)
        final_scores[cat] = clip01(final)
        if s_hits >= 1:
            final_scores[cat] = max(final_scores[cat], FLOOR_FORCED)
            forced_flags.add(cat)

    # 3) damp education/visualization if VR signals exist
    if has_vr_signal(t):  # s_hits(VR空間 ∪ インタラクション ∪ アバター) >= 1
        for cat in ["教育", "可視化"]:
            if cat in final_scores:
                final_scores[cat] = clip01(final_scores[cat] - DAMP)

    # 4) sort & pick top3
    top3 = sort_desc(final_scores)[:3]

    # 5) need_review
    need_review = "yes" if len(top3)>=2 and (top3[0].score - top3[1].score) < TIE_DELTA else "no"

    return top3, need_review
```

---

# 6. カテゴリ埋め込みの作り方（bge-m3 側）

* 各カテゴリの **代表文**（短い説明＋代表語）を作り、`category_seed_text[cat]` とする。
* 例（VR空間）:
  「VR空間や仮想環境、メタバース、HMD、VRChat、cluster などの**仮想世界そのものやその構築・体験**に関する研究」
* `category_vectors[cat] = embed_bge_m3(category_seed_text[cat])`
* 代表文は**1〜3行**、過度に長くしない（ノイズ混入を避ける）。
* **運用で定期的に更新**（新語や利用実態にあわせて再埋め込み）。

---

# 7. バッチ再採点（既存CSVに適用）

1. 既存の候補列（`suggestion1..3/score1..3`）は**参考**にとどめ、本文から **再計算** するのが安全。
2. 新規列として `final_suggestion1..3 / final_score1..3 / final_need_review` を出力。
3. **差分検証**: 旧top1と新top1の一致率、VR系カテゴリの出現率の変化をログ化。
4. **閾値調整**: `BETA` / `FLOOR_FORCED` / `DAMP` / `TIE_DELTA` を 2〜3回のABで最適化。

---

# 8. 評価プロトコル

* **指標**

  * VR系カテゴリ（VR空間/インタラクション/アバター/CG・デジタルアーカイブ/ソーシャルVR）の **検出率** 上昇
  * **人手アノテーション**（20〜50件）での top1 精度 / top3 包含率
  * `need_review="yes"` の**発報精度**（本当に曖昧なものを拾えているか）

* **停止基準**

  * VR系検出率が **+15〜30pt** 改善
  * 人手top3包含率 **>85%** 到達
  * 過剰ブーストによる誤爆（非VRをVR扱い）の比率 **<5%**

---

# 9. 失敗パターンと対策

* **ノイズ語による誤爆**

  * 対策: `strong/weak` の見直し、弱語を減らし強語中心へ、`anti` を導入。
* **教育/可視化の過抑制**

  * 対策: `DAMP` を 0.03→0.02へ下げる、VR信号要件を「強語2個以上」に引き上げ。
* **固有名詞不足**

  * 対策: 運用で**新固有名詞**を継続的に `strong` に追加し、週次で辞書を再配布。
* **長文での埋め込み希釈**

  * 対策: 入力を **要約（抽出）** してから埋め込み、またはセクション分割→最大スコア採用。

---

# 10. 実装・運用タスクリスト（やること）

1. **辞書整備**

   * 上記JSONをベースに、社内コーパスから **固有名詞** を追加（週次更新）。
2. **カテゴリ代表文の作成＆埋め込み保存**

   * `category_seed_text` を記述 → bge-m3でベクトル化 → キャッシュ。
3. **ハイブリッド採点の実装**

   * 正規化 → bge-m3埋め込み → ルール加点 → 合成 → 抑制 → top3 → `need_review`。
4. **バッチ再採点**（既存CSV）

   * 新列 `final_*` を出力。
5. **ABテスト**

   * `BETA, FLOOR_FORCED, DAMP, TIE_DELTA` を2〜3設定で比較。
6. **評価**

   * 人手アノテーション20〜50件で top1/top3/発報精度を算出。
7. **閾値確定 → 本番反映**

   * 週次で辞書アップデート。新語はまず `weak` に入れ、安定したら `strong` へ昇格。

---
