# Categorizer-Go-

日本語テキストを既存カテゴリや日本十進分類法（NDC）の候補に自動分類するデスクトップアプリケーションです。Fyne 製の GUI を備えており、複数行テキストや CSV/TSV ファイルの一括分類、カテゴリ候補の調整などを行えます。

## 必要条件

- Go 1.24 以降
- ONNX Runtime の共有ライブラリ（Windows では `onnxruntime.dll`）
- BGE-M3 などの埋め込みモデル（ONNX 形式）と対応する `tokenizer.json`
- 日本語フォントが利用できるデスクトップ環境

> **補足**: レポジトリに含まれる `onnixruntime-win` ディレクトリは公式配布物のメタデータとスタブのみです。実際の `onnxruntime.dll` は公式配布から取得して配置してください。

## 初期セットアップ

1. [ONNX Runtime (Windows x64)](https://github.com/microsoft/onnxruntime/releases) などから DLL を取得し、`onnixruntime-win/lib/onnxruntime.dll` として配置します。
2. Hugging Face などから BGE-M3 の ONNX 版モデルを取得し、次の構成で保存します。

   ```
   models/
     bge-m3/
       model.onnx
       tokenizer.json
   ```

3. 必要であれば `config/categories_seed.txt` を編集し、既定のカテゴリを調整します。ファイルが存在しない場合は起動時に自動生成されます。
4. 起動時に `config/category_rules.json` が存在しない場合、`internal/app/hybrid.go` の既定ルールから自動生成されます。強・弱・アンチキーワードを調整したい場合はこのファイルを編集してください。
5. キャッシュ用ディレクトリ `cache/` は起動時に自動作成されます。不要になったキャッシュは削除して構いません。

> **別環境で使用する場合**: `internal/app/config.go` の `defaultConfig()` で DLL やモデルのパスを変更してください。現状はローカルファイルパスを読み込む構成です。

## 起動方法

依存ファイルを配置したら、ルートディレクトリで次のコマンドを実行します。

```bash
go run .
```

GUI が起動し、テキスト分類を開始できます。実行時にモデルファイルや DLL が見つからない場合は、標準出力にエラーメッセージが表示されます。

バイナリを生成したい場合は次の通りです。

```bash
go build -o categorizer
```

生成したバイナリは同じパス構成で実行してください。

## 使い方の概要

1. **入力タブ**: 単文または複数行テキストを貼り付けます。1 行が 1 件として扱われます。
2. **分類実行**: ツールバーの「分類実行」を押すと、各行に対して上位 3〜5 件の候補が計算され、「結果」タブに一覧表示されます。
3. **ファイル読込**: CSV/TSV ファイルからテキスト列を選択して一括分類できます。先頭行がヘッダーの場合、自動的に列候補を推定します。
4. **カテゴリ読込**: 外部テキストファイルからカテゴリリストを読み込み、ユーザー定義カテゴリを更新します。
5. **設定**: ランキングモード（カテゴリのみ／混合／NDC 分離）、NDC 利用有無、しきい値、クラスタリング設定などを GUI 上で変更できます。
6. **CSV エクスポート**: 分類結果を CSV として保存できます。

アプリは ONNX Runtime を通じて文章埋め込みを生成し、ユーザーカテゴリおよび NDC 辞書とのコサイン類似度でスコアリングします。初回起動時はモデル読み込みとベクトルキャッシュの構築に時間がかかる場合があります。

## カテゴリルールのカスタマイズ

`internal/app/hybrid.go` にはハイブリッドスコアリングで用いる既定のキーワードルール（Strong/Weak/Anti）がハードコードされています。アプリ起動時には同じ内容を基にした `config/category_rules.json` が生成され、以降はこの JSON を編集することで個別のカテゴリルールを自由に変更できます。

- ファイルはカテゴリ名をキーとしたオブジェクトで構成され、各カテゴリに `Strong`・`Weak`・`Anti` の配列を指定します。
- 例:

  ```json
  {
    "VR空間": {
      "Strong": ["VR空間", "仮想空間"],
      "Weak": ["ワールド"],
      "Anti": []
    }
  }
  ```

ファイルを保存した後にアプリを再起動すると、変更内容がスコアリングに反映されます。JSON の読み込みに失敗した場合は標準出力にメッセージが表示され、`hybrid.go` の既定ルールが自動的に使われます。

## ディレクトリ構成

- `cmd/categorizer/`: 旧来のエントリポイント。`go run ./cmd/categorizer` でも起動できます。
- `internal/app/`: アプリケーション本体（サービス層、UI、設定、ヘルパー）。
- `emb/`: ONNX Runtime ベースの埋め込みエンジン。
- `config/`: 既定カテゴリや `category_rules.json` などの設定ファイル。
- `csv/`: デモ用 CSV ファイル（サンプル入力）。
- `cache/`: 埋め込みベクトルのキャッシュが保存されます（初回起動時に作成）。

## トラブルシューティング

- **初期化エラー: `onnxruntime.dll` が見つかりません**
  - 指定したパスが正しいか、DLL が 64bit 版であるか確認してください。
- **`model.onnx` や `tokenizer.json` が見つからない**
  - `defaultConfig()` 内のパス設定と実ファイル位置を合わせてください。
- **GUI が表示されない / クラッシュする**
  - Fyne は OpenGL を利用します。GPU ドライバーを最新化し、必要なランタイム（Windows なら MSVC 再頒布パッケージ）をインストールしてください。

## ライセンス

ソースコードはリポジトリのライセンスに従います。組み込みモデルや ONNX Runtime のライセンスは各配布元をご確認ください。
